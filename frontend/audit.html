<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hist√≥rico de Auditoria - CalibraCore Lab</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/animations.css">
</head>

<body>
    <div class="page-wrapper">
        <!-- Navbar -->
        <nav class="navbar">
            <div class="container">
                <a href="/dashboard" class="navbar-brand">
                    <img src="/img/logo_white.png" alt="N√∫cleo" style="height: 40px; margin-right: 10px;">
                    <span>CalibraCore Lab</span>
                </a>

                <div class="navbar-menu">
                    <a href="/dashboard" class="navbar-link">Dashboard</a>
                    <a href="/equipamentos" class="navbar-link">Equipamentos</a>
                    <a href="/usuarios" class="navbar-link" data-admin-only>Usu√°rios</a>
                    <a href="/audit.html" class="navbar-link active" data-admin-only>Auditoria</a>
                </div>

                <div class="user-menu">
                    <div class="user-info">
                        <div class="user-name" id="user-name">Usu√°rio</div>
                        <div class="user-role" id="user-role">Papel</div>
                    </div>
                    <button class="btn-logout" id="btn-logout">Sair</button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <!-- Page Header -->
                <div style="margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: flex-end;">
                    <div>
                        <h1>Auditoria</h1>
                        <p class="text-muted">Hist√≥rico completo de altera√ß√µes no sistema</p>
                    </div>
                    <button class="btn btn-secondary" onclick="loadAuditLogs()">
                        <span>üîÑ Atualizar</span>
                    </button>
                </div>

                <div class="table-container">
                    <div id="table-loading" class="loading">
                        <div class="spinner"></div>
                    </div>

                    <div id="table-empty" class="empty-state" style="display: none;">
                        <div class="icon">üìú</div>
                        <h3>Nenhum registro encontrado</h3>
                    </div>

                    <table id="audit-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Usu√°rio</th>
                                <th>A√ß√£o</th>
                                <th>Tabela</th>
                                <th>ID Registro</th>
                                <th>Altera√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="audit-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (!requireAuth()) return;
            if (!requireAdmin()) {
                window.location.href = '/dashboard';
                return;
            }

            setupNavbar();
            loadAuditLogs();
        });

        async function loadAuditLogs() {
            const loading = document.getElementById('table-loading');
            const empty = document.getElementById('table-empty');
            const table = document.getElementById('audit-table');
            const tbody = document.getElementById('audit-tbody');

            loading.style.display = 'flex';
            empty.style.display = 'none';
            table.style.display = 'none';

            try {
                const logs = await API.request('/api/audit?limit=100');

                loading.style.display = 'none';

                if (!logs || logs.length === 0) {
                    empty.style.display = 'block';
                    return;
                }

                table.style.display = 'table';
                tbody.innerHTML = logs.map(log => {
                    let changesHtml = '-';
                    if (log.changes) {
                        try {
                            const c = JSON.parse(log.changes);
                            changesHtml = Object.keys(c)
                                .map(k => `<span style="color: var(--accent-light)">${k}</span>: ${c[k]}`)
                                .join('<br>');
                        } catch (e) {
                            changesHtml = log.changes;
                        }
                    }

                    const actionClass = log.action === 'CREATE' ? 'badge-ok' :
                        log.action === 'DELETE' ? 'badge-danger' :
                            'badge-warning-30';

                    return `
                        <tr>
                            <td style="white-space: nowrap;">${Utils.formatDateTime(log.timestamp)}</td>
                            <td><strong>${log.user_nome || 'Sistema'}</strong></td>
                            <td><span class="badge ${actionClass}">${log.action}</span></td>
                            <td><code>${log.table_name}</code></td>
                            <td>${log.record_id}</td>
                            <td style="font-size: 0.85rem; max-width: 400px; overflow-wrap: break-word;">${changesHtml}</td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error(error);
                loading.style.display = 'none';
                empty.innerHTML = `<div class="icon">‚ö†Ô∏è</div><h3>Erro ao carregar auditoria</h3><p>${error.message}</p>`;
                empty.style.display = 'block';
            }
        }
    </script>
</body>

</html>
</body>

</html>